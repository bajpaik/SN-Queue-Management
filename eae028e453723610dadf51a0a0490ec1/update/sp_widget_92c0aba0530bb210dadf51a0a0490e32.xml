<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[api.controller = function($scope, $http, $location, spUtil, spNotificationEvents, i18n) {
	/*************************************************************************
	 * THIS IS TO BE USED AS AN EMBEDDED WIDGET TO THE OTHER WALK-UP WIDGETS *
	 *************************************************************************/
	/* widget controller */
	var c = this;

	// Declare constants here
	var AWAY_STATE_FIELD = 'enable_away_state';
	var urlParameters = $location.search();
	var sysId;

	if (c.data.embed.sys_id) {
		sysId = c.data.embed.sys_id;
	} else {
		sysId = urlParameters.location_id;
	}

	var CHECK_IN_PAGE = 'CHECK_IN';
	c.data.options = c.options;

	fetchScheduleConfig(sysId, function(sysId) {
		fetchScheduleStatus(sysId);
	});

	// Initialize controller variables
	c.nextAvailableDate = '';
	c.nextAvailableTime = '';

	c.showSchedule = function() {
		if (!c.data.schedule || !sysId)
			return false;

		if (c.data.schedule.enableAway)
			return true;
		// Handle the case for when the away schedule is on the check in page
		else if (c.data.page === CHECK_IN_PAGE)
			return !c.data.schedule.isCheckInOpen;

		else
			return !c.data.schedule.withinSchedule;
	};

	c.isClosed = function() {
		return !c.data.schedule.isCheckInOpen;
	};

	c.isAway = function() {
		return c.data.schedule.enableAway && c.data.schedule.isCheckInOpen;
	};

	spUtil.recordWatch($scope, "wu_location_queue", "sys_id=" + sysId, function(name) {
		var data = name.data;
		for (var i = 0, len = data.changes.length; i < len; i++ ) {
			if (data.changes[i] === AWAY_STATE_FIELD) {
				var enableAway = (data.record.enable_away_state.value === 'true');
				c.data.schedule.enableAway = c.data.isUpgrading || enableAway;
			}
		}
	});

	/**
	 * Fetch the schedule configurations from the walkupl location
	 * @param sysId {string} - sys id of the walk up location
	 */
	function fetchScheduleConfig(sysId, callback) {
		if (!sysId)
			return false;

		c.server.get({
			action: c.data.actions.getConfigurations,
			locationId: sysId
		}).then(function(response) {
			var data = response.data.config;
			c.data.awayMessage = data.awayMessage;
			c.data.closedMessage = data.closedMessage;
			c.data.image = data.awayImage;
			c.data.lastCheckIn = data.lastCheckIn;
			c.data.lastCheckInMsg = data.lastCheckInMsg;
			c.data.phoneNumber = data.phoneNumber;
			c.data.isUpgrading = data.isUpgrading;

			callback(sysId);
		});
	}

	/**
	 * Get information about the schedule that is attached to the walk up location.
	 * Will set the appropiate configurations in c.data to reflect the relation of
	 * the current time to the walk up schedule hours.
	 * @param sysId {string} - sys id of the walk up location
	 */
	function fetchScheduleStatus(sysId) {
		if (!sysId)
			return false;
		c.server.get({
			action: c.data.actions.getSchedule,
			locationId: sysId
		}).then(function(response) {
 			var data = response.data.schedule;
			c.data.schedule = data;
			var scheduleTz = spUtil.getMomentTimeZone(data.timeZone);

			// Get the current time from the server instead of from the browser
			var currentTime = moment.utc(data.currentTime);
			currentTime.tz(scheduleTz);

			// Only set the date time if there exists a schedule
			if (data.hasSchedule) {
				formatNextAvailableHours(data.nextAvailableStart, data.nextAvailableEnd, scheduleTz);
				setTimerToOpenWalkUp(data.nextAvailableStart, scheduleTz, data.withinSchedule, currentTime);
				setTimerToCloseWalkUp(data.nextAvailableEnd, scheduleTz, data.withinSchedule, currentTime);

				if (c.data.lastCheckIn > 0)
					setTimerToCloseCheckIn(data.lastCheckInTime, scheduleTz, data.withinSchedule, currentTime);

				c.data.schedule.isCheckInOpen = isCheckInOpen(data.lastCheckInTime, scheduleTz, data.withinSchedule, currentTime);
			}
			// PRB1308073: If schedule is invalid, treat as closed
			else if (!data.hasSchedule && !data.withinSchedule)
				c.data.schedule.isCheckInOpen = false;
			else
				c.data.schedule.isCheckInOpen = true;

			// withinSchedule will default to true if there is no defined schedule or an invalid one
			c.data.schedule.hideSchedule = !data.enableAway && data.withinSchedule;
		});
	}

	/**
	 * Set a timeout for a function that will trigger when a walk up location closes.
	 * Will only be called if the current time is within the scheduled hours.
	 * The appropriate c.data configurations will be set to reflect closed hours.
	 * @param end {string} - When the walk up location closes
	 * @param timeZone {string} - TimeZone that the schedule is set to run on
	 * @param withinSchedule {boolean} - Flag to check if current time is within the schedule
	 */
	function setTimerToCloseWalkUp(end, timeZone, withinSchedule, currentTime) {
		if (withinSchedule) {
			var endTime = moment.tz(end, timeZone);
			var diff = endTime.diff(currentTime);

			setTimeout(function() {
				c.server.get({
					action: c.data.actions.getCurrentOperatingHours,
					locationId: sysId,
					timeZone: timeZone
				}).then(function(response) {
					var data = response.data.schedule;

					if (data.error)
						return false;

					formatNextAvailableHours(data.span.start, data.span.end, c.data.schedule.timeZone);

					// Get the current time from the server instead of from the browser
					var currentTimeOpen = moment.utc(response.currentTime);
					currentTimeOpen.tz(timeZone);

					setTimerToOpenWalkUp(data.span.start, c.data.schedule.timeZone, false, currentTimeOpen);

					c.data.schedule.nextAvailableStart = data.span.start;
					c.data.schedule.nextAvailableEnd = data.span.end;
					c.data.schedule.isCheckInOpen = false;
					c.data.schedule.withinSchedule = false;

				});
			}, diff);
		}
	}

	/**
	 * Set a timeout for a function that will trigger when a walk up location opens.
	 * Will only be called if the current time is NOT within the scheduled hours.
	 * The appropriate c.data configurations will be set to reflect open hours.
	 * @param openTime {string} - When the walk up location opens
	 * @param timeZone {string} - TimeZone that the schedule is set to run on
	 * @param withinSchedule {boolean} - Flag to check if current time is within the schedule
	 */
	function setTimerToOpenWalkUp(openTime, timeZone, withinSchedule, currentTime) {
		if (!withinSchedule) {
			var open = moment.tz(openTime, timeZone);
			var diff = open.diff(currentTime);

			setTimeout(function() {
				fetchScheduleStatus(sysId);
			}, diff);
		}
	}

	/**
	 * Set a timeout for a function that will trigger when a walk up location closes check in functionality.
	 * Will only be called if the current time is before the last check ins
	 * The appropriate c.data configurations will be set to reflect closed check in
	 * @param lastCheckInTime {string} - The time the walk up location stops accepting check in
	 * @param timeZone {string} - TimeZone that the schedule is set to run on
	 * @param withinSchedule {boolean} - Flag to check if current time is within the schedule
	 */
	function setTimerToCloseCheckIn(lastCheckInTime, timeZone, withinSchedule, currentTime) {
		if (withinSchedule) {
			var endTime = moment.tz(lastCheckInTime, timeZone);
			var diff = endTime.diff(currentTime);

			// Call to server to get next schedule NOT the current schedule
			setTimeout(function() {
				c.server.get({
					action: c.data.actions.getNextOperatingHours,
					locationId: sysId,
					timeZone: timeZone
				}).then(function(response) {
					var data = response.data.schedule;
					if (data.error) {
						c.data.schedule.withinSchedule = true;
						return false;
					}

					formatNextAvailableHours(data.span.start, data.span.end, c.data.schedule.timeZone);

					c.data.schedule.nextAvailableStart = data.span.start;
					c.data.schedule.nextAvailableEnd = data.span.end;
					c.data.schedule.isCheckInOpen = false;
				});
			}, diff);
		}
	}

	/**
	 * Formats the next available hours, in human readable format
	 * @param start {string} - start time
	 * @param end {string} - end time
	 * @param timeZone {string} - timezone of the schedule
	 */
	function formatNextAvailableHours(start, end, timeZone) {
		var startTime = moment.tz(start, timeZone);
		var endTime = moment.tz(end, timeZone);
		var isExactlyMidnight = (endTime.hours() === 0 && endTime.minutes() === 0);

		// If end date is at 00:00. Format it to be 11:59pm
		if (isExactlyMidnight)
			endTime.subtract(1, 'minute');

		var nextAvailableDate = [
			c. data.msgs.dayOfWeekTranslations[startTime.format('d')],
			', ',
			c.data.msgs.monthTranslations[startTime.format('M') - 1],
			' ',
			startTime.format('Do')
		].join('');

		var nextAvailableEndDate = [
			c. data.msgs.dayOfWeekTranslations[endTime.format('d')],
			', ',
			c.data.msgs.monthTranslations[endTime.format('M') - 1],
			' ',
			endTime.format('Do')
		].join('');

		var nextAvailableEnd = endTime.format('h:mma');
		var nextAvailableStart = startTime.format('h:mma');

		// Check if start and end dates are on the same day
		if (startTime.isSame(endTime, 'day')) {
			c.data.spanDays = false;
			c.nextAvailableDate = nextAvailableDate;
			c.nextAvailableTime = nextAvailableStart + ' - ' + nextAvailableEnd;
		}
		else {
			c.data.spanDays = true;
			c.nextAvailableDate = nextAvailableDate;
			c.nextAvailableTime = nextAvailableStart
			c.nextAvailableEndDate = nextAvailableEndDate;
			c.nextAvailableEndTime = nextAvailableEnd
		}
	}

	function isCheckInOpen(lastCheckInTime, timeZone, isAvailable, currentTime) {
		if (!isAvailable)
			return isAvailable;

		var lastCheckIn = moment.tz(lastCheckInTime, timeZone);

		return currentTime.isBefore(lastCheckIn);
	}

}]]></client_script>
        <controller_as>c</controller_as>
        <css>.available-hrs-wrapper {&#13;
  display: block;&#13;
  margin-left: auto;&#13;
  margin-right: auto;&#13;
  text-align: center;&#13;
  img {&#13;
    width: 100%;&#13;
  }&#13;
}&#13;
&#13;
.away-msg {&#13;
  padding-bottom: 40px;&#13;
  max-width: 592px;&#13;
  margin-left: auto;&#13;
  margin-right: auto;&#13;
  h1.h3 {&#13;
    font-weight: 600;&#13;
  }&#13;
&#13;
  h2.h3 {&#13;
    font-weight: 400;&#13;
    margin-top: 10px;&#13;
  }&#13;
}&#13;
&#13;
.next-available {&#13;
  color: $primary;&#13;
  h2 {&#13;
    margin-bottom: 20px;&#13;
    font-weight: 600;&#13;
    &amp;.h1 {&#13;
      font-size: 56px;&#13;
    }&#13;
&#13;
    &amp;.h2 {&#13;
      font-size: 40px;&#13;
    }&#13;
  }&#13;
}&#13;
&#13;
.separator {&#13;
  height: 4px;&#13;
  width: 16px;&#13;
  background-color: $primary;&#13;
  display: block;&#13;
  margin-left: auto;&#13;
  margin-right: auto;&#13;
}</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description>Display the schedule for a particular walk-up location</description>
        <docs/>
        <field_list/>
        <has_preview>true</has_preview>
        <id>gqi-walkup-schedule</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {
  
}]]></link>
        <name>GQI Walkup Schedule</name>
        <option_schema/>
        <public>true</public>
        <roles/>
        <script><![CDATA[(function() {
    /* populate the 'data' object */
    var CONSTANTS = sn_walkup.WalkUpConstants;
    var actions = data.actions = {};
    var errorMsg = {};
    data.msgs = {};
    data.msgs.dayOfWeekTranslations = [
        gs.getMessage('Sunday'),
        gs.getMessage('Monday'),
        gs.getMessage('Tuesday'),
        gs.getMessage('Wednesday'),
        gs.getMessage('Thursday'),
        gs.getMessage('Friday'),
        gs.getMessage('Saturday')
    ];

    data.msgs.monthTranslations = [
        gs.getMessage('Jan'),
        gs.getMessage('Feb'),
        gs.getMessage('Mar'),
        gs.getMessage('Apr'),
        gs.getMessage('May'),
        gs.getMessage('Jun'),
        gs.getMessage('Jul'),
        gs.getMessage('Aug'),
        gs.getMessage('Sep'),
        gs.getMessage('Oct'),
        gs.getMessage('Nov'),
        gs.getMessage('Dec')
    ];
    var embed = data.embed = {};

    actions.getSchedule = 'GET_SCHEDULE';
    actions.getNextOperatingHours = 'GET_NEXT_OPERATING_HOURS';
    actions.getCurrentOperatingHours = 'GET_CURRENT_OPERATING_HOURS';
    actions.getConfigurations = 'GET_CONFIGURATION';

    var walkUpUtil = new sn_walkup.ExtPointUtil().loadExtension("WalkUpUtil");
    var scheduleUtil = new sn_walkup.ExtPointUtil().loadExtension("WalkUpScheduleUtil");

    if (input) {

        if (input.action === actions.getSchedule) {
            data.schedule = scheduleUtil.getSchedule(input.locationId)

        } else if (input.action === actions.getCurrentOperatingHours) {
            data.schedule = scheduleUtil.getCurrentOperatingHours(input.locationId, input.timeZone);
        } else if (input.action === actions.getNextOperatingHours) {
            data.schedule = scheduleUtil.getNextOperatingHours(input.locationId, input.timeZone);
        } else if (input.action === actions.getConfigurations) {
            data.config = getConfigurations(input.locationId);
        } else if (input.action === CONSTANTS.RENDER_WIDGET) {
            embed.sys_id = input.sys_id;
        }
        // Initial load of widget
        else {
            data.page = input.page;
        }


        data.currentTime = new GlideDateTime().toString();
    }

    //Keeping function after refactor; fetching configs from walkUpUtil API and formatting within widget
    function getConfigurations(sysId) {
        var config = walkUpUtil.fetchQueueConfig(sysId);
        return {
            awayMessage: config.awayMessage,
            awayImage: config.awayImage,
            closedMessage: config.closedMessage,
            lastCheckIn: config.lastCheckIn,
            lastCheckInMsg: config.lastCheckInMsg,
            phoneNumber: config.phoneNumber,
            enableAwayState: config.enableAwayState,
            isUpgrading: config.isUpgrading
        };
    }

})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2026-02-11 01:48:34</sys_created_on>
        <sys_id>92c0aba0530bb210dadf51a0a0490e32</sys_id>
        <sys_mod_count>1</sys_mod_count>
        <sys_name>GQI Walkup Schedule</sys_name>
        <sys_package display_value="GQI Queue Management" source="x_80404_gqi_queu_0">eae028e453723610dadf51a0a0490ec1</sys_package>
        <sys_policy/>
        <sys_scope display_value="GQI Queue Management">eae028e453723610dadf51a0a0490ec1</sys_scope>
        <sys_update_name>sp_widget_92c0aba0530bb210dadf51a0a0490e32</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2026-02-11 01:49:00</sys_updated_on>
        <template><![CDATA[<div>
  <div ng-if="c.showSchedule()">
    <div class="available-hrs-wrapper">

      <section class="away-msg">
        <h2 ng-if="c.isAway()"class="h3" tabindex="0" aria-label="{{c.data.awayMessage}}">
          {{c.data.awayMessage}}
        </h2>
        <h2 ng-if="c.isClosed()"class="h3" tabindex="0" aria-label="{{c.data.closedMessage}}">
          {{c.data.closedMessage}}
        </h2>
      </section>

      <section class="next-available" ng-if="c.isClosed() && c.data.schedule.hasSchedule">
        <h1 class="h3" tabindex="0" aria-label="Next available time">
          ${Next available time}
        </h1>
        <h2 ng-class="{h1: !c.data.spanDays, h2: c.data.spanDays}" tabindex="0" aria-label="{{c.nextAvailableDate}}">
          {{c.nextAvailableDate}}
        </h2>
        <h2 ng-class="{h1: !c.data.spanDays, h2: c.data.spanDays}" tabindex="0" aria-label="{{c.nextAvailableTime}}">
          {{c.nextAvailableTime}}
        </h2>

        <!-- Display only when the next available time spans across multiple days -->
        <div ng-if="c.data.spanDays">
          <div class="separator"></div>
          <h2 ng-class="{h1: !c.data.spanDays, h2: c.data.spanDays}" tabindex="0" aria-label="{{c.nextAvailableDate}}">
            {{c.nextAvailableEndDate}}
          </h2>
          <h2 ng-class="{h1: !c.data.spanDays, h2: c.data.spanDays}" tabindex="0" aria-label="{{c.nextAvailableEndTime}}">
            {{c.nextAvailableEndTime}}
          </h2>
        </div>
      </section>

      <!-- Display contact information -->
      <section ng-if="c.data.phoneNumber">
        <h2 class="h3">
           {{c.data.phoneNumber}}
        </h2>
      </section>

    </div>
    <!--<walkup-logo ng-if="c.data.image" class="wu-logo" image="::c.data.image" alt="Away Logo"></walkup-logo> -->
  </div>
</div>]]></template>
    </sp_widget>
</record_update>
